name: Notify Downstream

on:
  push:
    branches: [main]

jobs:
  wait-for-ci:
    runs-on: ubuntu-latest
    steps:
      - name: Wait for CI
        uses: lewagon/wait-on-check-action@v1.3.4
        with:
          ref: ${{ github.sha }}
          check-name: 'Test (ubuntu-latest)'
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          wait-interval: 10

  notify:
    needs: wait-for-ci
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract commit info
        id: commit
        run: |
          MSG=$(git log -1 --pretty=%s)
          echo "message=$MSG" >> $GITHUB_OUTPUT
          echo "sha=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT
          echo "short_sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          if [[ "$MSG" =~ ^feat ]]; then echo "type=feat" >> $GITHUB_OUTPUT
          elif [[ "$MSG" =~ ^fix ]]; then echo "type=fix" >> $GITHUB_OUTPUT
          elif [[ "$MSG" =~ ^chore ]]; then echo "type=chore" >> $GITHUB_OUTPUT
          elif [[ "$MSG" =~ ^docs ]]; then echo "type=docs" >> $GITHUB_OUTPUT
          elif [[ "$MSG" =~ ^test ]]; then echo "type=test" >> $GITHUB_OUTPUT
          elif [[ "$MSG" =~ ^refactor ]]; then echo "type=refactor" >> $GITHUB_OUTPUT
          else echo "type=other" >> $GITHUB_OUTPUT
          fi

      - name: Notify meta_cli
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.PARENT_REPO_PAT }}
          repository: harmony-labs/meta_cli
          event-type: dependency-updated
          client-payload: |
            {
              "repo": "${{ github.repository }}",
              "repo_name": "${{ github.event.repository.name }}",
              "sha": "${{ steps.commit.outputs.sha }}",
              "short_sha": "${{ steps.commit.outputs.short_sha }}",
              "message": "${{ steps.commit.outputs.message }}",
              "type": "${{ steps.commit.outputs.type }}",
              "actor": "${{ github.actor }}"
            }

      - name: Notify meta_git_cli
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.PARENT_REPO_PAT }}
          repository: harmony-labs/meta_git_cli
          event-type: dependency-updated
          client-payload: |
            {
              "repo": "${{ github.repository }}",
              "repo_name": "${{ github.event.repository.name }}",
              "sha": "${{ steps.commit.outputs.sha }}",
              "short_sha": "${{ steps.commit.outputs.short_sha }}",
              "message": "${{ steps.commit.outputs.message }}",
              "type": "${{ steps.commit.outputs.type }}",
              "actor": "${{ github.actor }}"
            }

      - name: Notify meta_project_cli
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.PARENT_REPO_PAT }}
          repository: harmony-labs/meta_project_cli
          event-type: dependency-updated
          client-payload: |
            {
              "repo": "${{ github.repository }}",
              "repo_name": "${{ github.event.repository.name }}",
              "sha": "${{ steps.commit.outputs.sha }}",
              "short_sha": "${{ steps.commit.outputs.short_sha }}",
              "message": "${{ steps.commit.outputs.message }}",
              "type": "${{ steps.commit.outputs.type }}",
              "actor": "${{ github.actor }}"
            }

      - name: Notify meta_rust_cli
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.PARENT_REPO_PAT }}
          repository: harmony-labs/meta_rust_cli
          event-type: dependency-updated
          client-payload: |
            {
              "repo": "${{ github.repository }}",
              "repo_name": "${{ github.event.repository.name }}",
              "sha": "${{ steps.commit.outputs.sha }}",
              "short_sha": "${{ steps.commit.outputs.short_sha }}",
              "message": "${{ steps.commit.outputs.message }}",
              "type": "${{ steps.commit.outputs.type }}",
              "actor": "${{ github.actor }}"
            }
